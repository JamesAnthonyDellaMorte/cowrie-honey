networks:
  honeypot:
    internal: true
  external:
    driver: bridge

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    platform: linux/arm64
    container_name: cowrie-backend
    hostname: mediaserver
    restart: always
    networks:
      - honeypot
    volumes:
      - ./dl:/var/spool/.captured
    mem_limit: 512m
    cpus: 1
    pids_limit: 256
    logging:
      options:
        max-size: "50m"
        max-file: "1"

  cowrie:
    image: cowrie/cowrie
    container_name: cowrie
    restart: always
    depends_on:
      - backend
    ports:
      - "22:2222"
    networks:
      - honeypot
      - external
    volumes:
      # Runtime data
      - ./dl:/cowrie/cowrie-git/var/lib/cowrie/downloads
      - ./log:/cowrie/cowrie-git/var/log/cowrie
      - ./keys:/cowrie/cowrie-git/var/lib/cowrie/keys
      # Config
      - ./cowrie.cfg:/cowrie/cowrie-git/etc/cowrie.cfg
      # Proxy SFTP override (friendly filenames)
      - ./ssh_proxy/sftp.py:/cowrie/cowrie-git/src/cowrie/ssh_proxy/protocols/sftp.py
    logging:
      options:
        max-size: "600m"
        max-file: "1"
