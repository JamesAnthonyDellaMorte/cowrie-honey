services:
  cowrie:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cowrie
    hostname: mediaserver
    restart: always
    ports:
      - "22:2222"
      - "23:2323"
      - "2222:2222"
      - "2200:2222"
      - "10022:2222"
    environment:
      - TZ=America/New_York
    volumes:
      # All captured samples â€” mounted at /mnt/captures to avoid overlay2 conflicts
      - ./dl:/mnt/captures
      # Logs and keys
      - ./log:/cowrie/cowrie-git/var/log/cowrie
      - ./keys:/cowrie/cowrie-git/var/lib/cowrie/keys
      # Config
      - ./cowrie.cfg:/cowrie/cowrie-git/etc/cowrie.cfg
      - ./userdb.txt:/cowrie/cowrie-git/etc/userdb.txt
      # Proxy SFTP override (friendly filenames)
      - ./ssh_proxy/sftp.py:/cowrie/cowrie-git/src/cowrie/ssh_proxy/protocols/sftp.py
      # Telnet proxy handler fix (accept \n line endings)
      - ./telnet_proxy/handler.py:/cowrie/cowrie-git/src/cowrie/telnet_proxy/handler.py
    # Balanced headroom: better capture throughput without taking over the host
    mem_limit: 3g
    memswap_limit: 4g
    cpus: 0.75
    pids_limit: 512
    healthcheck:
      test: ["CMD-SHELL", "pgrep sshd >/dev/null && pgrep -f twistd >/dev/null && pgrep -f rsyslogd >/dev/null && pgrep -f syslog-ng >/dev/null && pgrep inetutils-inetd >/dev/null"]
      interval: 60s
      retries: 3
      start_period: 30s
    logging:
      options:
        max-size: "600m"
        max-file: "1"
